<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Pulsa Music Conect</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* CSS Extra para garantir que os √≠cones fiquem escondidos */
        input::-webkit-calendar-picker-indicator,
        input::-webkit-inner-spin-button,
        input::-webkit-clear-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
    </style>
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    {% set foto_url = musico.foto if musico.foto else 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1000' %}

    <div id="cursor-aura"></div>
    <div class="bg-scene">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

        <nav class="glass-nav">
            <a href="/" style="text-decoration: none;">
                <div class="logo">PULSA<span>MUSIC</span>CONECT</div>
            </a>
            <div class="menu-toggle" id="mobile-menu">
                <span class="bar"></span><span class="bar"></span><span class="bar"></span>
            </div>
            <ul class="nav-links" id="nav-links">
                <li><a href="/" class="btn-nav-link">HOME</a></li>
                {% if session.get('user_email') %}
                    <li><a href="/dashboard" class="btn-user-status">PAINEL</a></li>
                    <li><a href="javascript:void(0)" onclick="abrirModalSenha()" class="btn-user-status">ALTERAR SENHA</a></li>
                    <li><a href="/logout" class="btn-logout">SAIR</a></li>
                {% endif %}
            </ul>
        </nav>

        <div id="modal-senha" class="modal-overlay">
            <div class="modal-content glass-card">
                <button class="close-modal" onclick="fecharModalSenha()">√ó</button>
                <h3>Trocar Senha</h3>
                <p style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 20px;">Digite sua nova senha abaixo.</p>
                
                <form id="form-trocar-senha" class="nebula-form">
                    <div class="input-modern">
                        <input type="password" id="nova-senha" required placeholder=" ">
                        <label>NOVA SENHA</label>
                    </div>
                    <div class="input-modern" style="margin-top: 15px;">
                        <input type="password" id="confirma-senha" required placeholder=" ">
                        <label>CONFIRMAR SENHA</label>
                    </div>
                    
                    <button type="submit" class="btn-glow-action" style="margin-top: 25px; width: 100%;">
                        <span>ATUALIZAR SENHA</span>
                    </button>
                </form>
            </div>
        </div>

    <main class="dash-main">
        <header class="dash-intro">
            <h1 class="reveal-text">PAINEL<span>CRIATIVO</span></h1>
            <p>Gerencie seus pedidos e sua presen√ßa digital.</p>
        </header>
        <section class="config-grid">
            <div class="preview-panel" id="card-preview">
                <div class="preview-sticky">
                    <span class="label-mini">PR√âVIA DO PERFIL</span>
                    <div class="modern-card preview-card">
                        <div class="card-image" id="preview-img" style="background-image: url('{{ foto_url }}');"></div>
                        <div class="card-overlay">
                            <span class="tag" id="preview-tag">{{ musico.estilo or 'Estilo' }}</span>
                            <h3 id="preview-name">{{ musico.nome or 'Nome do Artista' }}</h3>
                            <p style="font-size: 0.7rem; color: rgba(255,255,255,0.8); margin-top: 5px; font-weight: 500;">
                                üìç <span id="preview-cidade">{{ musico.cidade or 'Cidade' }}</span> - <span id="preview-estado">{{ musico.estado or 'UF' }}</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        <section class="inbox-section">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                    <h2 class="section-label">üì© CAIXA DE ENTRADA</h2>
                    <span class="count-badge">{{ pedidos|length }} Mensagens</span>
                </div>
                
                <div id="bulk-actions" style="display: none;">
                    <button onclick="excluirSelecionados()" class="btn-delete-small" style="background: #ff4444; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 0.7rem; font-weight: bold;">
                        üóëÔ∏è EXCLUIR SELECIONADOS (<span id="selected-count">0</span>)
                    </button>
                </div>
            </div>

            <div class="messages-list">
                {% if pedidos|length > 0 %}
                <div style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="select-all-messages" onclick="toggleSelectAll(this)" style="cursor: pointer;">
                    <label for="select-all-messages" style="font-size: 0.7rem; opacity: 0.6; cursor: pointer;">SELECIONAR TUDO</label>
                </div>
                {% endif %}

                {% for pedido in pedidos %}
                <div class="message-item {% if not pedido.lido %}unread{% endif %}" style="display: flex; align-items: center; gap: 12px;">
                    <input type="checkbox" class="msg-checkbox" value="{{ pedido.id }}" onclick="event.stopPropagation(); updateBulkUI()" style="cursor: pointer;">
                    
                    <div style="flex: 1; cursor: pointer; display: flex; align-items: center; gap: 10px;" 
                        onclick="abrirMensagem('{{ pedido.id }}', '{{ pedido.nome_contratante }}', '{{ pedido.email_contratante }}', '{{ pedido.telefone_contratante }}', '{{ pedido.data_evento }}', '{{ pedido.local_evento }}', '{{ pedido.tipo_evento }}')">
                        <div class="msg-status"></div>
                        <div class="msg-info">
                            <span class="msg-sender">{{ pedido.cliente_email }}</span> 
                            <span class="msg-preview">Evento: {{ pedido.tipo_evento }}</span>
                        </div>
                        <span class="msg-date" style="margin-left: auto;">{{ pedido.data_evento }}</span>
                    </div>

                    <button onclick="event.stopPropagation(); excluirMensagemIndividual('{{ pedido.id }}')" 
                            style="background: none; border: none; color: #ff4444; cursor: pointer; padding: 5px; opacity: 0.6; transition: 0.3s;" 
                            title="Excluir">
                        ‚úï
                    </button>
                </div>
                {% else %}
                <div class="empty-inbox">Nenhuma solicita√ß√£o recebida ainda.</div>
                {% endfor %}
            </div>
        </section>

        <section class="agenda-manager-section" style="margin-top: 40px;">
            <div class="section-header">
                <h2 class="section-label">üìÖ GEST√ÉO DE AGENDA</h2>
            </div>
            
            <div class="glass-card" style="padding: 20px; margin-bottom: 20px;">
                <form action="/adicionar_agenda" method="POST" autocomplete="off" aria-autocomplete="none" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end;">
                    
                    <input type="text" name="fake_user" style="display:none" aria-hidden="true">
                    <input type="password" name="fake_pass" style="display:none" aria-hidden="true">

                    <div class="input-modern">
                        <input type="date" name="data_show" required data-lpignore="true" data-1p-ignore>
                        <label class="label-fixed">DATA</label>
                    </div>
                    
                    <div class="input-modern">
                        <input type="time" name="horario_show" required data-lpignore="true" data-1p-ignore> 
                        <label class="label-fixed">HOR√ÅRIO</label>
                    </div>

                    <div class="input-modern">
                        <input type="text" name="nome_festa" placeholder="Ex: Festival..." autocomplete="new-password" data-lpignore="true"> 
                        <label class="label-fixed">NOME DA FESTA</label>
                    </div>

                    <div class="input-modern">
                        <input type="text" name="local" placeholder="Ex: Pra√ßa..." required autocomplete="new-password" data-lpignore="true">
                        <label class="label-fixed">LOCAL</label>
                    </div>

                    <div class="input-modern">
                        <input type="text" name="cidade" placeholder="Ex: S√£o Luiz..." required autocomplete="new-password" data-lpignore="true">
                        <label class="label-fixed">CIDADE</label>
                    </div>

                    <button type="submit" class="btn-glow-action" style="height: 45px;">
                        <span>+ ADD SHOW</span>
                    </button>
                </form>
            </div>

            <div class="messages-list">
                {% for show in agenda %}
                <div class="message-item">
                    <div class="msg-info">
                        <span class="msg-sender">{{ show.data_dia }}/{{ show.data_mes }} - {{ show.local }}</span>
                        <span class="msg-preview">{{ show.cidade }}</span>
                    </div>
                    <form action="/remover_agenda/{{ show.id }}" method="POST">
                        <button type="submit" style="background: none; border: none; color: #ff4444; cursor: pointer; font-size: 0.8rem;">[EXCLUIR]</button>
                    </form>
                </div>
                {% else %}
                <div class="empty-inbox">Nenhum show na agenda ainda.</div>
                {% endfor %}
            </div>
        </section>

            <div class="form-panel">
                <form action="{{ url_for('cadastrar_musico') }}" method="POST" enctype="multipart/form-data" class="nebula-form" autocomplete="off">
                    <div class="form-section">
                        <h2 class="section-label">DADOS DO PERFIL</h2>
                        
                        <div class="input-modern">
                            <input type="text" name="nome" id="input-name" required placeholder=" " value="{{ musico.nome or '' }}" data-lpignore="true">
                            <label>NOME DA BANDA / ARTISTA</label>
                        </div>

                        <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 15px;">
                            <div class="input-modern">
                                <input type="text" name="cidade" id="input-cidade" required placeholder=" " value="{{ musico.cidade or '' }}" data-lpignore="true">
                                <label>CIDADE</label>
                            </div>
                            <div class="input-modern">
                                <input type="text" name="estado" id="input-estado" required placeholder=" " maxlength="2" value="{{ musico.estado or '' }}" style="text-transform: uppercase;" data-lpignore="true">
                                <label>UF</label>
                            </div>
                        </div>

                        <div class="input-modern">
                            <select name="estilo" id="select-style">
                                {% for estilo in estilos %}
                                    <option value="{{ estilo }}"
                                        {% if musico.estilo == estilo %}selected{% endif %}>
                                        {{ estilo }}
                                    </option>
                                {% endfor %}
                            </select>

                            <label class="label-fixed">G√äNERO MUSICAL</label>
                        </div>

                        <div class="image-config-box" style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 25px;">
                            <div class="input-modern" style="margin-bottom: 10px;">
                                <input type="url" name="foto_url" id="input-url" placeholder=" " value="{{ musico.foto if musico.foto and musico.foto.startswith('http') else '' }}" data-lpignore="true">
                                <label>URL DA FOTO (LINK EXTERNO)</label>
                            </div>
                            <div style="text-align: center; margin: 10px 0; font-size: 0.7rem; color: #ffffff; letter-spacing: 2px;">OU FA√áA UPLOAD</div>
                            <div class="input-modern">
                                <input type="file" name="foto_arquivo" id="input-file" accept="image/*" style="padding-top: 10px;">
                                <label class="label-fixed">ARQUIVO LOCAL (PASTA IMG)</label>
                            </div>
                        </div>

                        <div class="input-modern">
                            <textarea name="bio" rows="4" placeholder=" " data-lpignore="true">{{ musico.bio or '' }}</textarea>
                            <label>SUA HIST√ìRIA (BIO)</label>
                        </div>
                    </div>

                    <button type="submit" class="btn-glow-action">
                        <span>SALVAR ALTERA√á√ïES</span>
                    </button>
                </form>
            </div>
        </section>
    </main>

    <div id="modal-leitura" class="modal-overlay">
        <div class="modal-content glass-card">
            <button class="close-modal" onclick="fecharModal()">√ó</button>
            <h3>Detalhes da Solicita√ß√£o</h3>
            <hr class="modal-divider">
            <div class="modal-body">
                <p><strong>Solicitante:</strong> <span id="view-nome"></span></p>
                <p><strong>E-mail:</strong> <span id="view-email"></span></p>
                <p>
                    <strong>WhatsApp:</strong> 
                    <a href="#" id="link-telefone-zap" target="_blank" style="color: #25d366; text-decoration: none; font-weight: bold;">
                        <span id="view-telefone"></span>
                    </a>
                </p>
                <hr class="modal-divider-vagas">
                <p><strong>Data do Evento:</strong> <span id="view-data"></span></p>
                <p><strong>Local:</strong> <span id="view-local"></span></p>
                <p><strong>Tipo de Evento:</strong> <span id="view-tipo"></span></p>
                
                <div class="alert-info">Combine os detalhes e o cach√™ diretamente com o cliente.</div>
            </div>

            <a href="" id="btn-whats-action" target="_blank" class="btn-glow-action" style="text-decoration: none; text-align: center; display: block; background: #25d366; margin-bottom: 10px;">
                <span>RESPONDER PELO WHATSAPP</span>
            </a>

            <a href="" id="btn-responder" class="btn-glow-action" style="text-decoration: none; text-align: center; display: block; opacity: 0.8;">
                <span>RESPONDER POR E-MAIL</span>
            </a>
        </div>
    </div>

    <script>
        // Elementos de Preview
        const inputName = document.getElementById('input-name');
        const inputUrl = document.getElementById('input-url');
        const inputFile = document.getElementById('input-file');
        const selectStyle = document.getElementById('select-style');
        
        // ADICIONADO: Elementos de Cidade/Estado
        const inputCidade = document.getElementById('input-cidade');
        const inputEstado = document.getElementById('input-estado');
        const previewCidade = document.getElementById('preview-cidade');
        const previewEstado = document.getElementById('preview-estado');

        const previewName = document.getElementById('preview-name');
        const previewTag = document.getElementById('preview-tag');
        const previewImg = document.getElementById('preview-img');
        const imagemDoBanco = "{{ musico.foto or 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1000' }}";

        function atualizarCard() {
            // Pega os valores dos inputs ou usa o valor padr√£o do Jinja
            const nomeVal = inputName.value.trim() || "{{ musico.nome or 'Nome do Artista' }}";
            const estiloVal = selectStyle.value || "{{ musico.estilo or 'Estilo' }}";
            
            // ADICIONADO: L√≥gica de atualiza√ß√£o de localidade
            previewCidade.innerText = inputCidade.value.trim() || "{{ musico.cidade or 'Cidade' }}";
            previewEstado.innerText = inputEstado.value.trim().toUpperCase() || "{{ musico.estado or 'UF' }}";

            previewName.innerText = nomeVal;
            previewTag.innerText = estiloVal;

            // L√≥gica da Imagem
            if (inputFile.files && inputFile.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => previewImg.style.backgroundImage = `url('${e.target.result}')`;
                reader.readAsDataURL(inputFile.files[0]);
            } else if (inputUrl.value.trim() !== "") {
                previewImg.style.backgroundImage = `url('${inputUrl.value.trim()}')`;
            } else {
                previewImg.style.backgroundImage = `url('${imagemDoBanco}')`;
            }
        }

        window.addEventListener('load', atualizarCard);

        inputName.addEventListener('input', atualizarCard);
        inputUrl.addEventListener('input', atualizarCard);
        inputFile.addEventListener('change', atualizarCard);
        selectStyle.addEventListener('change', atualizarCard);
        
        // ADICIONADO: Ouvintes de evento para Cidade e Estado
        inputCidade.addEventListener('input', atualizarCard);
        inputEstado.addEventListener('input', atualizarCard);
        
        window.addEventListener('DOMContentLoaded', atualizarCard);

        // Fun√ß√µes para a Modal de Senha
        function abrirModalSenha() {
            document.getElementById('modal-senha').classList.add('active');
        }

        function fecharModalSenha() {
            document.getElementById('modal-senha').classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', function () {
            const formSenha = document.getElementById('form-trocar-senha');

            if (!formSenha) return;

            formSenha.addEventListener('submit', function(e) {
                e.preventDefault();
                const novaSenha = document.getElementById('nova-senha').value;
                const confirmaSenha = document.getElementById('confirma-senha').value;

                if (novaSenha !== confirmaSenha) {
                    alert("As senhas n√£o coincidem!");
                    return;
                }

                fetch('/api_registrar_troca_senha', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nova_senha: novaSenha })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert("Senha atualizada com sucesso!");
                        fecharModalSenha();
                        formSenha.reset();
                    } else {
                        alert("Erro: " + data.message);
                    }
                })
                .catch(err => {
                    console.error("‚ùå Erro:", err);
                    alert("Erro ao comunicar com o servidor.");
                });
            });
        });

        window.onclick = function(event) {
            const modalSenha = document.getElementById('modal-senha');
            if (event.target == modalSenha) {
                fecharModalSenha();
            }
        }

        function abrirMensagem(id, nome, email, tel, data, local, tipo) {
            document.getElementById('view-nome').innerText = nome || 'N√£o informado';
            document.getElementById('view-email').innerText = email || 'N√£o informado';
            document.getElementById('view-telefone').innerText = tel || 'N√£o informado';
            document.getElementById('view-data').innerText = data || 'N√£o informada';
            document.getElementById('view-local').innerText = local || 'N√£o informado';
            document.getElementById('view-tipo').innerText = tipo || 'N√£o informado';

            const nomeDoArtista = "{{ musico.nome }}";

            if (tel) {
                const numeroLimpo = tel.replace(/\D/g, "");
                const msgZap = `Ol√° ${nome}, aqui √© da banda ${nomeDoArtista}. Vi que voc√™ solicitou um or√ßamento para um show atrav√©s do portal Pulsa S√£o Luiz para o dia ${data} em ${local}. Podemos conversar?`;
                const linkZap = `https://wa.me/55${numeroLimpo}?text=${encodeURIComponent(msgZap)}`;
                document.getElementById('link-telefone-zap').href = linkZap;
                document.getElementById('btn-whats-action').href = linkZap;
            }

            if (email) {
                const assunto = `Or√ßamento Show: ${nomeDoArtista} | Pulsa S√£o Luiz`;
                const corpoEmail = `Ol√° ${nome},\n\nAqui √© da banda ${nomeDoArtista}. Recebi seu pedido de or√ßamento atrav√©s do portal Pulsa S√£o Luiz para o evento no dia ${data} em ${local}.\n\nGostaria de confirmar minha disponibilidade e conversar sobre os detalhes.\n\nAguardo seu retorno!\nAtenciosamente,\n${nomeDoArtista}`;
                const linkGmail = `https://mail.google.com/mail/?view=cm&fs=1&to=${email}&su=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpoEmail)}`;
                const btnEmail = document.getElementById('btn-responder');
                btnEmail.href = linkGmail;
                btnEmail.target = "_blank";
            }

            document.getElementById('modal-leitura').classList.add('active');
            fetch(`/marcar_lido/${id}`, { method: 'POST' });
        }

        function fecharModal() {
            document.getElementById('modal-leitura').classList.remove('active');
            location.reload(); 
        }

        const mobileMenu = document.getElementById('mobile-menu');
        const navLinks = document.getElementById('nav-links');

        mobileMenu.addEventListener('click', () => {
            mobileMenu.classList.toggle('active');
            navLinks.classList.toggle('active');
            document.body.style.overflow = navLinks.classList.contains('active') ? 'hidden' : 'auto';
        });

        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('active');
                navLinks.classList.remove('active');
                document.body.style.overflow = 'auto';
            });
        });

        function updateBulkUI() {
            const checkboxes = document.querySelectorAll('.msg-checkbox:checked');
            const bulkBar = document.getElementById('bulk-actions');
            const countSpan = document.getElementById('selected-count');
            
            if (bulkBar && countSpan) {
                if (checkboxes.length > 0) {
                    bulkBar.style.display = 'block';
                    countSpan.innerText = checkboxes.length;
                } else {
                    bulkBar.style.display = 'none';
                }
            }
        }

        function toggleSelectAll(master) {
            const checkboxes = document.querySelectorAll('.msg-checkbox');
            checkboxes.forEach(cb => cb.checked = master.checked);
            updateBulkUI();
        }

        function excluirMensagemIndividual(id) {
            if (confirm("Apagar esta mensagem?")) {
                enviarExclusao([id]);
            }
        }

        function excluirSelecionados() {
            const selecionados = Array.from(document.querySelectorAll('.msg-checkbox:checked')).map(cb => cb.value);
            if (selecionados.length > 0 && confirm(`Apagar as ${selecionados.length} mensagens selecionadas?`)) {
                enviarExclusao(selecionados);
            }
        }

        function showToast(mensagem) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span>üóëÔ∏è</span> ${mensagem}`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                    location.reload();
                }, 500);
            }, 2500);
        }

        function enviarExclusao(listaIds) {
            fetch('/excluir_pedidos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: listaIds })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast(listaIds.length > 1 ? "Mensagens exclu√≠das!" : "Mensagem exclu√≠da!");
                } else {
                    alert("Erro: " + data.message);
                }
            })
            .catch(err => console.error("Erro:", err));
        }
    </script>
</body>
</html>