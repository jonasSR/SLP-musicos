<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Rio de Sons</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* CSS Extra para garantir que os √≠cones fiquem escondidos */
        input::-webkit-calendar-picker-indicator,
        input::-webkit-inner-spin-button,
        input::-webkit-clear-button {
            display: none !important;
            -webkit-appearance: none !important;
        }
    </style>
</head>
<body>
    {% set foto_url = musico.foto if musico.foto else 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1000' %}

    <div id="cursor-aura"></div>
    <div class="bg-scene">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

        <nav class="glass-nav">
            <a href="/" style="text-decoration: none;">
                <div class="logo">PULSA<span>PARAITINGA</span></div>
            </a>
            <div class="menu-toggle" id="mobile-menu">
                <span class="bar"></span><span class="bar"></span><span class="bar"></span>
            </div>
            <ul class="nav-links" id="nav-links">
                <li><a href="/" class="btn-nav-link">HOME</a></li>
                {% if session.get('user_email') %}
                    <li><a href="/dashboard" class="btn-user-status">PAINEL</a></li>
                    <li><a href="javascript:void(0)" onclick="abrirModalSenha()" class="btn-user-status">ALTERAR SENHA</a></li>
                    <li><a href="/logout" class="btn-logout">SAIR</a></li>
                {% endif %}
            </ul>
        </nav>

        <div id="modal-senha" class="modal-overlay">
            <div class="modal-content glass-card">
                <button class="close-modal" onclick="fecharModalSenha()">√ó</button>
                <h3>Trocar Senha</h3>
                <p style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 20px;">Digite sua nova senha abaixo.</p>
                
                <form id="form-trocar-senha" class="nebula-form">
                    <div class="input-modern">
                        <input type="password" id="nova-senha" required placeholder=" ">
                        <label>NOVA SENHA</label>
                    </div>
                    <div class="input-modern" style="margin-top: 15px;">
                        <input type="password" id="confirma-senha" required placeholder=" ">
                        <label>CONFIRMAR SENHA</label>
                    </div>
                    
                    <button type="submit" class="btn-glow-action" style="margin-top: 25px; width: 100%;">
                        <span>ATUALIZAR SENHA</span>
                    </button>
                </form>
            </div>
        </div>

    <main class="dash-main">
        <header class="dash-intro">
            <h1 class="reveal-text">PAINEL<span>CRIATIVO</span></h1>
            <p>Gerencie seus pedidos e sua presen√ßa digital.</p>
        </header>
        <section class="config-grid">
            <div class="preview-panel" id="card-preview">
                <div class="preview-sticky">
                    <span class="label-mini">PR√âVIA DO PERFIL</span>
                    <div class="modern-card preview-card">
                        <div class="card-image" id="preview-img" style="background-image: url('{{ foto_url }}');"></div>
                        <div class="card-overlay">
                            <span class="tag" id="preview-tag">{{ musico.estilo or 'Estilo' }}</span>
                            <h3 id="preview-name">{{ musico.nome or 'Nome do Artista' }}</h3>
                        </div>
                    </div>
                </div>
            </div>

        <section class="inbox-section">
            <div class="section-header">
                <h2 class="section-label">üì© CAIXA DE ENTRADA</h2>
                <span class="count-badge">{{ pedidos|length }} Mensagens</span>
            </div>
            <div class="messages-list">
                {% for pedido in pedidos %}
                <div class="message-item {% if not pedido.lido %}unread{% endif %}" 
                    onclick="abrirMensagem('{{ pedido.id }}', '{{ pedido.nome_contratante }}', '{{ pedido.email_contratante }}', '{{ pedido.telefone_contratante }}', '{{ pedido.data_evento }}', '{{ pedido.local_evento }}', '{{ pedido.tipo_evento }}')">
                    <div class="msg-status"></div>
                    <div class="msg-info">
                        <span class="msg-sender">{{ pedido.cliente_email }}</span> 
                        <span class="msg-preview">Evento: {{ pedido.tipo_evento }}</span>
                    </div>
                    <span class="msg-date">{{ pedido.data_evento }}</span>
                </div>
                {% else %}
                <div class="empty-inbox">Nenhuma solicita√ß√£o recebida ainda.</div>
                {% endfor %}
            </div>
        </section>

        <section class="agenda-manager-section" style="margin-top: 40px;">
            <div class="section-header">
                <h2 class="section-label">üìÖ GEST√ÉO DE AGENDA</h2>
            </div>
            
            <div class="glass-card" style="padding: 20px; margin-bottom: 20px;">
                <form action="/adicionar_agenda" method="POST" autocomplete="off" aria-autocomplete="none" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end;">
                    
                    <input type="text" name="fake_user" style="display:none" aria-hidden="true">
                    <input type="password" name="fake_pass" style="display:none" aria-hidden="true">

                    <div class="input-modern">
                        <input type="date" name="data_show" required data-lpignore="true" data-1p-ignore>
                        <label class="label-fixed">DATA</label>
                    </div>
                    
                    <div class="input-modern">
                        <input type="time" name="horario_show" required data-lpignore="true" data-1p-ignore> 
                        <label class="label-fixed">HOR√ÅRIO</label>
                    </div>

                    <div class="input-modern">
                        <input type="text" name="nome_festa" placeholder="Ex: Festival..." autocomplete="new-password" data-lpignore="true"> 
                        <label class="label-fixed">NOME DA FESTA</label>
                    </div>

                    <div class="input-modern">
                        <input type="text" name="local" placeholder="Ex: Pra√ßa..." required autocomplete="new-password" data-lpignore="true">
                        <label class="label-fixed">LOCAL</label>
                    </div>

                    <div class="input-modern">
                        <input type="text" name="cidade" placeholder="Ex: S√£o Luiz..." required autocomplete="new-password" data-lpignore="true">
                        <label class="label-fixed">CIDADE</label>
                    </div>

                    <button type="submit" class="btn-glow-action" style="height: 45px;">
                        <span>+ ADD SHOW</span>
                    </button>
                </form>
            </div>

            <div class="messages-list">
                {% for show in agenda %}
                <div class="message-item">
                    <div class="msg-info">
                        <span class="msg-sender">{{ show.data_dia }}/{{ show.data_mes }} - {{ show.local }}</span>
                        <span class="msg-preview">{{ show.cidade }}</span>
                    </div>
                    <form action="/remover_agenda/{{ show.id }}" method="POST">
                        <button type="submit" style="background: none; border: none; color: #ff4444; cursor: pointer; font-size: 0.8rem;">[EXCLUIR]</button>
                    </form>
                </div>
                {% else %}
                <div class="empty-inbox">Nenhum show na agenda ainda.</div>
                {% endfor %}
            </div>
        </section>

            <div class="form-panel">
                <form action="{{ url_for('cadastrar_musico') }}" method="POST" enctype="multipart/form-data" class="nebula-form" autocomplete="off">
                    <div class="form-section">
                        <h2 class="section-label">DADOS DO PERFIL</h2>
                        
                        <div class="input-modern">
                            <input type="text" name="nome" id="input-name" required placeholder=" " value="{{ musico.nome or '' }}" data-lpignore="true">
                            <label>NOME DA BANDA / ARTISTA</label>
                        </div>

                        <div class="input-modern">
                            <select name="estilo" id="select-style">
                                <option value="Marchinha" {% if musico.estilo == 'Marchinha' %}selected{% endif %}>Marchinha</option>
                                <option value="Regional / MPB" {% if musico.estilo == 'Regional / MPB' %}selected{% endif %}>Regional / MPB</option>
                                <option value="Choro" {% if musico.estilo == 'Choro' %}selected{% endif %}>Choro</option>
                                <option value="Rock Rural" {% if musico.estilo == 'Rock Rural' %}selected{% endif %}>Rock Rural</option>
                                
                                <option value="Samba" {% if musico.estilo == 'Samba' %}selected{% endif %}>Samba</option>
                                <option value="Forr√≥ / Xote" {% if musico.estilo == 'Forr√≥ / Xote' %}selected{% endif %}>Forr√≥ / Xote</option>
                                <option value="Sertanejo Raiz" {% if musico.estilo == 'Sertanejo Raiz' %}selected{% endif %}>Sertanejo Raiz</option>
                                <option value="Instrumental" {% if musico.estilo == 'Instrumental' %}selected{% endif %}>Instrumental</option>
                                <option value="Jazz / Blues" {% if musico.estilo == 'Jazz / Blues' %}selected{% endif %}>Jazz / Blues</option>
                                <option value="Pop Rock" {% if musico.estilo == 'Pop Rock' %}selected{% endif %}>Pop Rock</option>
                                <option value="Bossa Nova" {% if musico.estilo == 'Bossa Nova' %}selected{% endif %}>Bossa Nova</option>
                                <option value="Cultura Popular" {% if musico.estilo == 'Cultura Popular' %}selected{% endif %}>Cultura Popular (Congada/Mo√ßambique)</option>
                            </select>
                            <label class="label-fixed">G√äNERO MUSICAL</label>
                        </div>

                        <div class="image-config-box" style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 25px;">
                            <div class="input-modern" style="margin-bottom: 10px;">
                                <input type="url" name="foto_url" id="input-url" placeholder=" " value="{{ musico.foto if musico.foto and musico.foto.startswith('http') else '' }}" data-lpignore="true">
                                <label>URL DA FOTO (LINK EXTERNO)</label>
                            </div>
                            <div style="text-align: center; margin: 10px 0; font-size: 0.7rem; color: #ffffff; letter-spacing: 2px;">OU FA√áA UPLOAD</div>
                            <div class="input-modern">
                                <input type="file" name="foto_arquivo" id="input-file" accept="image/*" style="padding-top: 10px;">
                                <label class="label-fixed">ARQUIVO LOCAL (PASTA IMG)</label>
                            </div>
                        </div>

                        <div class="input-modern">
                            <textarea name="bio" rows="4" placeholder=" " data-lpignore="true">{{ musico.bio or '' }}</textarea>
                            <label>SUA HIST√ìRIA (BIO)</label>
                        </div>
                    </div>

                    <button type="submit" class="btn-glow-action">
                        <span>SALVAR ALTERA√á√ïES</span>
                    </button>
                </form>
            </div>
        </section>
    </main>

    <div id="modal-leitura" class="modal-overlay">
        <div class="modal-content glass-card">
            <button class="close-modal" onclick="fecharModal()">√ó</button>
            <h3>Detalhes da Solicita√ß√£o</h3>
            <hr class="modal-divider">
            <div class="modal-body">
                <p><strong>Solicitante:</strong> <span id="view-nome"></span></p>
                <p><strong>E-mail:</strong> <span id="view-email"></span></p>
                <p>
                    <strong>WhatsApp:</strong> 
                    <a href="#" id="link-telefone-zap" target="_blank" style="color: #25d366; text-decoration: none; font-weight: bold;">
                        <span id="view-telefone"></span>
                    </a>
                </p>
                <hr class="modal-divider-vagas">
                <p><strong>Data do Evento:</strong> <span id="view-data"></span></p>
                <p><strong>Local:</strong> <span id="view-local"></span></p>
                <p><strong>Tipo de Evento:</strong> <span id="view-tipo"></span></p>
                
                <div class="alert-info">Combine os detalhes e o cach√™ diretamente com o cliente.</div>
            </div>

            <a href="" id="btn-whats-action" target="_blank" class="btn-glow-action" style="text-decoration: none; text-align: center; display: block; background: #25d366; margin-bottom: 10px;">
                <span>RESPONDER PELO WHATSAPP</span>
            </a>

            <a href="" id="btn-responder" class="btn-glow-action" style="text-decoration: none; text-align: center; display: block; opacity: 0.8;">
                <span>RESPONDER POR E-MAIL</span>
            </a>
        </div>
    </div>

    <script>
        // Scripts de Preview permanecem iguais
        const inputName = document.getElementById('input-name');
        const inputUrl = document.getElementById('input-url');
        const inputFile = document.getElementById('input-file');
        const selectStyle = document.getElementById('select-style');
        const previewName = document.getElementById('preview-name');
        const previewTag = document.getElementById('preview-tag');
        const previewImg = document.getElementById('preview-img');
        const imagemDoBanco = "{{ musico.foto or 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1000' }}";

        function atualizarCard() {
            // Pega os valores dos inputs ou usa o valor padr√£o do Jinja
            const nomeVal = inputName.value.trim() || "{{ musico.nome or 'Nome do Artista' }}";
            const estiloVal = selectStyle.value || "{{ musico.estilo or 'Estilo' }}";
            
            previewName.innerText = nomeVal;
            previewTag.innerText = estiloVal;

            // L√≥gica da Imagem
            if (inputFile.files && inputFile.files[0]) {
                // 1. Prioridade: Se o usu√°rio selecionou um arquivo agora
                const reader = new FileReader();
                reader.onload = (e) => previewImg.style.backgroundImage = `url('${e.target.result}')`;
                reader.readAsDataURL(inputFile.files[0]);
            } else if (inputUrl.value.trim() !== "") {
                // 2. Segunda prioridade: Se o usu√°rio colou um link
                previewImg.style.backgroundImage = `url('${inputUrl.value.trim()}')`;
            } else {
                // 3. Fallback: Imagem que veio do banco de dados (vari√°vel imagemDoBanco)
                previewImg.style.backgroundImage = `url('${imagemDoBanco}')`;
            }
        }

        // Garante que o card apare√ßa assim que o site abrir
        window.addEventListener('load', () => {
            console.log("Carregando pr√©via com a imagem:", imagemDoBanco);
            atualizarCard();
        });

        inputName.addEventListener('input', atualizarCard);
        inputUrl.addEventListener('input', atualizarCard);
        inputFile.addEventListener('change', atualizarCard);
        selectStyle.addEventListener('change', atualizarCard);
        window.addEventListener('DOMContentLoaded', atualizarCard);

        // Fun√ß√µes para a Modal de Senha
        function abrirModalSenha() {
            document.getElementById('modal-senha').classList.add('active');
        }

        function fecharModalSenha() {
            document.getElementById('modal-senha').classList.remove('active');
        }

        // <<< COLOQUE O C√ìDIGO AQUI >>>
        document.addEventListener('DOMContentLoaded', function () {
            const formSenha = document.getElementById('form-trocar-senha');

            if (!formSenha) {
                console.error("‚ùå Formul√°rio de troca de senha n√£o encontrado");
                return;
            }

            formSenha.addEventListener('submit', function(e) {
                e.preventDefault();

                const novaSenha = document.getElementById('nova-senha').value;
                const confirmaSenha = document.getElementById('confirma-senha').value;

                if (novaSenha !== confirmaSenha) {
                    alert("As senhas n√£o coincidem!");
                    return;
                }

                fetch('/api_registrar_troca_senha', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nova_senha: novaSenha })
                })
                .then(res => res.json())
                .then(data => {
                    console.log("üî• RESPOSTA:", data);

                    if (data.status === 'success') {
                        alert("Senha atualizada com sucesso!");
                        fecharModalSenha();
                        formSenha.reset();
                    } else {
                        alert("Erro: " + data.message);
                    }
                })
                .catch(err => {
                    console.error("‚ùå Erro:", err);
                    alert("Erro ao comunicar com o servidor.");
                });
            });
        });


        // Fechar modal ao clicar fora dela (opcional, mas recomendado)
        window.onclick = function(event) {
            const modalSenha = document.getElementById('modal-senha');
            if (event.target == modalSenha) {
                fecharModalSenha();
            }
        }

        function abrirMensagem(id, nome, email, tel, data, local, tipo) {
            // 1. Preenche os textos b√°sicos no Modal
            document.getElementById('view-nome').innerText = nome || 'N√£o informado';
            document.getElementById('view-email').innerText = email || 'N√£o informado';
            document.getElementById('view-telefone').innerText = tel || 'N√£o informado';
            document.getElementById('view-data').innerText = data || 'N√£o informada';
            document.getElementById('view-local').innerText = local || 'N√£o informado';
            document.getElementById('view-tipo').innerText = tipo || 'N√£o informado';

            // 2. L√≥gica para o WhatsApp
            if (tel) {
                const numeroLimpo = tel.replace(/\D/g, "");
                const msgZap = `Ol√° ${nome}, vi seu interesse no portal Rio de Sons para o evento no dia ${data} em ${local}. Podemos conversar?`;
                const linkZap = `https://wa.me/55${numeroLimpo}?text=${encodeURIComponent(msgZap)}`;
                
                document.getElementById('link-telefone-zap').href = linkZap;
                document.getElementById('btn-whats-action').href = linkZap;
            }

            // 3. L√≥gica para abrir GMAIL em outra aba
            if (email) {
                const banda = "{{ musico.nome }}";
                const assunto = `Or√ßamento Rio de Sons: ${tipo}`;
                const corpo = `Ol√° ${nome},\n\nRecebi seu pedido para o dia ${data} em ${local}. Gostaria de confirmar minha disponibilidade.\n\nAguardo seu retorno!\n\nAtenciosamente,\n${banda}`;

                // Link oficial do Gmail para compor mensagem (Abre em aba do navegador)
                const linkGmail = `https://mail.google.com/mail/?view=cm&fs=1&to=${email}&su=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;

                const btnEmail = document.getElementById('btn-responder');
                btnEmail.href = linkGmail;
                btnEmail.target = "_blank"; // ISSO garante que abra em outra aba
            }

            // 4. Abre o modal e marca como lido
            document.getElementById('modal-leitura').classList.add('active');
            fetch(`/marcar_lido/${id}`, { method: 'POST' });
        }

        function fecharModal() {
            document.getElementById('modal-leitura').classList.remove('active');
            location.reload(); 
        }


        const mobileMenu = document.getElementById('mobile-menu');
            const navLinks = document.getElementById('nav-links');

            mobileMenu.addEventListener('click', () => {
                mobileMenu.classList.toggle('active');
                navLinks.classList.toggle('active');
                
                // Trava o scroll do corpo quando o menu estiver aberto
                if (navLinks.classList.contains('active')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = 'auto';
                }
            });

            // Fecha o menu ao clicar em qualquer link
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.remove('active');
                    navLinks.classList.remove('active');
                    document.body.style.overflow = 'auto';
                });
            });
    </script>

    
</body>
</html>