<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Acesso Artista | Pulsa S√£o Luiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script type="module" src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
    
</head>

<body class="login-page-root">
{% if confirmacao_venda %}
<div id="modal-boas-vindas" class="modal-overlay" style="display:flex;">
    <div class="modal-content glass-card">
        <h3 style="color:#00ffcc;">Bem-vindo √† Pulsa Music Conect!</h3>
        <p style="margin-top:15px;">Sua assinatura foi confirmada com sucesso üöÄ</p>
        
        <p style="font-size:0.9rem; color:#ccc; margin-top:15px;">
            Defina uma senha para acessar seu painel:
        </p>

        <input type="hidden" id="email-venda" value="">
        
        <div class="input-group" style="margin-top:15px;">
            <input type="password" id="nova-senha" placeholder="Crie sua senha" class="log-input">
        </div>

        <button class="log-btn-main" style="margin-top:20px;" onclick="vincularSenhaAoPagamento()">
            FINALIZAR E ENTRAR
        </button>
    </div>
</div>
{% endif %}

    <div class="log-bg-mesh"></div>

    <div class="log-card-container">
        <a href="{{ url_for('index') }}" class="btn-back-home">
            <span>‚Üê</span> Voltar
        </a>

        <h1 class="log-glitch-title">Acesso ao <span>Painel</span></h1>
        <p class="log-subtitle">Gest√£o de Perfil | Pulsa Music Conect.</p>

        <form id="auth-form" class="log-form-wrapper">
            <div class="log-field-group">
                <input type="email" id="email" class="log-input-field" required placeholder=" ">
                <label class="log-field-label">E-MAIL CORPORATIVO OU ART√çSTICO</label>
            </div>

            <div class="log-field-group log-pass-group">
                <input type="password" id="password" class="log-input-field" required minlength="7" placeholder=" ">
                <label class="log-field-label">SENHA (M√çN. 7 CARACTERES)</label>

                <button type="button" class="log-toggle-eye" aria-label="Mostrar senha">
                    üëÅ
                </button>
            </div>

            <button type="submit" id="btn-login" class="log-btn-main">
                CONECTAR
            </button>

            <button type="button" id="btn-signup" class="log-btn-main log-btn-outline">
                CRIAR CONTA
            </button>

            <div id="modal-auth" class="modal-overlay">
                <div class="modal-content glass-card">
                    <span class="close-modal" id="btn-close-x">&times;</span>
                    <h3 id="modal-title">Aten√ß√£o</h3>
                    <p id="modal-text">Preencha o usu√°rio e a senha e clique em criar conta.</p>
                    <button type="button" class="log-btn-main" id="btn-modal-confirm" style="width: 100%; margin-top: 15px;">ENTENDI</button>
                </div>
            </div>

            <button type="button" onclick="loginComGoogle()" class="google-btn-modern">
                <div class="google-icon-wrapper">
                    <img class="google-icon" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                </div>
                <span class="btn-text">ENTRAR COM GOOGLE</span>
            </button>

        </form>
    </div>

    <div id="modal-escolha-perfil" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3>Como deseja entrar?</h3>
            <p>Selecione seu tipo de perfil para continuar:</p>
            
            <div class="opcoes-perfil">
                <button type="button" class="btn-perfil" id="btn-escolha-musico">
                    üé∏ SOU M√öSICO / BANDA
                </button>
                
                <button type="button" class="btn-perfil" id="btn-escolha-empresa">
                    üè¢ SOU ESTABELECIMENTO
                </button>
            </div>
        </div>
    </div>

    <div id="modal-retomar-cadastro" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3 style="color: #ffcc00;">Cadastro em Aberto</h3>
            <p>Vimos que voc√™ parou seu cadastro como: <br>
            <strong id="tipo-pendente" style="color: #fff; font-size: 1.2em;"></strong>
            </p>
            <p style="font-size: 0.9em; color: #ccc;">Deseja continuar?</p>
            
            <div class="opcoes-perfil">
                <button type="button" class="btn-perfil" id="btn-retomar-sim" style="background: #00ff88; color: #000;">
                    CONTINUAR CADASTRO
                </button>
                
                <button type="button" class="btn-perfil btn-perfil-cancelar" id="btn-retomar-nao">
                    SAIR E CONTINUAR DEPOIS
                </button>
            </div>
        </div>
    </div>

    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
    // 1. Pega o e-mail que veio na URL (ex: ?email=...)
    const params = new URLSearchParams(window.location.search);
    const emailPagante = params.get('email');

    if (emailPagante) {
        document.getElementById('email-venda').value = emailPagante;
    }
});

async function vincularSenhaAoPagamento() {
    const email = document.getElementById('email-venda').value;
    const senha = document.getElementById('nova-senha').value;

    if (!senha || senha.length < 6) {
        exibirPopup("Aten√ß√£o", "A senha deve ter no m√≠nimo 6 caracteres.");
        return;
    }

    if (!email) {
        exibirPopup("Erro", "E-mail n√£o identificado. Por favor, use o cadastro comum.");
        return;
    }

    try {
        // 1. Cria o acesso no Firebase Authentication (O que estava faltando)
        await createUserWithEmailAndPassword(auth, email, senha);

        // 2. Atualiza o documento que J√Å EXISTE no Firestore (para garantir o tipo e status)
        await setDoc(doc(db, "usuarios", email), {
            acesso_pago: true,
            status: 'completo' // Ou a l√≥gica que voc√™ usa para liberar o painel
        }, { merge: true });

        exibirPopup("Sucesso!", "Senha cadastrada com sucesso!");

        // 3. Inicia sess√£o e manda pro Dashboard
        await iniciarSessao(email);
        window.location.href = "/dashboard";

    } catch (error) {
        console.error(error);
        if (error.code === 'auth/email-already-in-use') {
            exibirPopup("Aten√ß√£o", "Este e-mail j√° possui senha. Tente fazer login.");
        } else {
            exibirPopup("Erro", "N√£o foi poss√≠vel criar sua senha.");
        }
    }
}
        // Colocamos aspas para o editor achar que √© uma String comum
        // O | safe garante que o Flask n√£o quebre os caracteres
        const configData = '{{ firebase_config | tojson | safe }}';
        
        // Agora transformamos essa string em um objeto de verdade
        window.firebaseConfig = JSON.parse(configData);
        
        console.log("üî• Configura√ß√£o do Firebase injetada!");
    </script>
    <script type="module" src="{{ url_for('static', filename='js/auth.js') }}"></script>
</body>
</html>