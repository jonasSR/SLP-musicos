<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Acesso Artista | Pulsa S√£o Luiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script type="module" src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
    
</head>

<body class="login-page-root">
    {% if confirmacao_venda %}
<div id="modal-finalizar-cadastro" class="modal-overlay" style="display:flex;">
    <div class="modal-content glass-card">
        <h3 style="color:#00ffcc;">Obrigado pela compra! üöÄ</h3>

        <p style="margin-top:15px;">
            Complete seu cadastro para acessar o Dashboard.
        </p>

        <form id="form-finalizar-cadastro">
            <!-- E-mail j√° preenchido e bloqueado -->
            <input type="email" id="email_venda" value="{{ session.get('user_email_venda', '') }}" readonly
                style="margin-top:10px; width:100%; padding:10px; border-radius:5px; border:1px solid #ccc;">

            <!-- Senha -->
            <input type="password" id="senha_venda" placeholder="Crie sua senha"
                style="margin-top:10px; width:100%; padding:10px; border-radius:5px; border:1px solid #ccc;">

            <button type="submit" class="log-btn-main" style="margin-top:15px; width:100%;">
                Finalizar Cadastro e Acessar Dashboard
            </button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('form-finalizar-cadastro');
    const email = document.getElementById('email_venda');
    const senha = document.getElementById('senha_venda');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!senha.value) {
            alert("Por favor, crie uma senha antes de continuar.");
            return;
        }

        try {
            // Cria usu√°rio no Firebase
            await createUserWithEmailAndPassword(auth, email.value, senha.value);

            // Salva no Firestore
            await setDoc(doc(db, "usuarios", email.value), {
                email: email.value,
                tipo: 'musico',  // ou 'estabelecimento' se tiver info
                acesso_pago: true,
                criado_via: 'pagina_vendas',
                data_cadastro: serverTimestamp()
            });

            // Cria sess√£o no Flask
            await fetch('/set_session', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({email: email.value})
            });

            // Redireciona direto para dashboard
            window.location.href = "/dashboard";

        } catch (error) {
            console.error("Erro ao finalizar cadastro:", error);
            alert("Ocorreu um erro: " + error.message);
        }
    });
});
</script>
{% endif %}


    <div class="log-bg-mesh"></div>

    <div class="log-card-container">
        <a href="{{ url_for('index') }}" class="btn-back-home">
            <span>‚Üê</span> Voltar
        </a>

        <h1 class="log-glitch-title">Acesso ao <span>Painel</span></h1>
        <p class="log-subtitle">Gest√£o de Perfil | Pulsa Music Conect.</p>

        <form id="auth-form" class="log-form-wrapper">
            <div class="log-field-group">
                <input type="email" id="email" class="log-input-field" required placeholder=" ">
                <label class="log-field-label">E-MAIL CORPORATIVO OU ART√çSTICO</label>
            </div>

            <div class="log-field-group log-pass-group">
                <input type="password" id="password" class="log-input-field" required minlength="7" placeholder=" ">
                <label class="log-field-label">SENHA (M√çN. 7 CARACTERES)</label>

                <button type="button" class="log-toggle-eye" aria-label="Mostrar senha">
                    üëÅ
                </button>
            </div>

            <button type="submit" id="btn-login" class="log-btn-main">
                CONECTAR
            </button>

            <button type="button" id="btn-signup" class="log-btn-main log-btn-outline">
                CRIAR CONTA
            </button>

            <div id="modal-auth" class="modal-overlay">
                <div class="modal-content glass-card">
                    <span class="close-modal" id="btn-close-x">&times;</span>
                    <h3 id="modal-title">Aten√ß√£o</h3>
                    <p id="modal-text">Preencha o usu√°rio e a senha e clique em criar conta.</p>
                    <button type="button" class="log-btn-main" id="btn-modal-confirm" style="width: 100%; margin-top: 15px;">ENTENDI</button>
                </div>
            </div>

            <button type="button" onclick="loginComGoogle()" class="google-btn-modern">
                <div class="google-icon-wrapper">
                    <img class="google-icon" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                </div>
                <span class="btn-text">ENTRAR COM GOOGLE</span>
            </button>

        </form>
    </div>

    <div id="modal-escolha-perfil" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3>Como deseja entrar?</h3>
            <p>Selecione seu tipo de perfil para continuar:</p>
            
            <div class="opcoes-perfil">
                <button type="button" class="btn-perfil" id="btn-escolha-musico">
                    üé∏ SOU M√öSICO / BANDA
                </button>
                
                <button type="button" class="btn-perfil" id="btn-escolha-empresa">
                    üè¢ SOU ESTABELECIMENTO
                </button>
            </div>
        </div>
    </div>

    <div id="modal-retomar-cadastro" class="modal-overlay">
        <div class="modal-content glass-card">
            <h3 style="color: #ffcc00;">Cadastro em Aberto</h3>
            <p>Vimos que voc√™ parou seu cadastro como: <br>
            <strong id="tipo-pendente" style="color: #fff; font-size: 1.2em;"></strong>
            </p>
            <p style="font-size: 0.9em; color: #ccc;">Deseja continuar?</p>
            
            <div class="opcoes-perfil">
                <button type="button" class="btn-perfil" id="btn-retomar-sim" style="background: #00ff88; color: #000;">
                    CONTINUAR CADASTRO
                </button>
                
                <button type="button" class="btn-perfil btn-perfil-cancelar" id="btn-retomar-nao">
                    SAIR E CONTINUAR DEPOIS
                </button>
            </div>
        </div>
    </div>

    
    <script>
        // Colocamos aspas para o editor achar que √© uma String comum
        // O | safe garante que o Flask n√£o quebre os caracteres
        const configData = '{{ firebase_config | tojson | safe }}';
        
        // Agora transformamos essa string em um objeto de verdade
        window.firebaseConfig = JSON.parse(configData);
        
        console.log("üî• Configura√ß√£o do Firebase injetada!");
    </script>
    <script type="module" src="{{ url_for('static', filename='js/auth.js') }}"></script>
</body>
</html>